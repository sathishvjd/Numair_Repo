/*
 Author: Numair Fazili
 Description: The following query is used to track recoveries via bank transfers for affected transfers in N3/N4 category
 to whom legal letters were sent on 14 December 2022
 */


WITH CTE AS (
    SELECT DISTINCT PMT.TRANSFER_ID,COALESCE(PCL.PAYOUT_CLASSIFICATION,PMT.PAYOUT_CLASSIFICATION) AS TRANSFER_STATE
    FROM REPORTS.PKR_DOUBLE_PAYOUT_MASTER_TABLE PMT
    LEFT JOIN  REPORTS.PKR_DOUBLE_PAYOUT_CHANGE_LOG PCL ON PCL.TRANSFER_ID = PMT.TRANSFER_ID

),

MAIN_TABLE AS (SELECT
DISTINCT CTE.TRANSFER_ID AS TRANSFER_ID,
LAST_VALUE(CTE.TRANSFER_STATE) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS TRANSFER_STATE,
LAST_VALUE(WI.STATE) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS WORK_ITEM_STATE,
LAST_VALUE(SOURCE_CURRENCY) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS SOURCE_CURRENCY,
LAST_VALUE(TARGET_CURRENCY) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS TARGET_CURRENCY,
LAST_VALUE(INVOICE_VALUE_LOCAL) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS AMOUNT_IN_SOURCE_CCY,
LAST_VALUE(FEE_VALUE_LOCAL) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS FEES_IN_SOURCE_CCY,
LAST_VALUE(INVOICE_VALUE_GBP) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS AMOUNT_IN_GBP,
LAST_VALUE(WI.LAST_UPDATED ) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS LAST_UPDATED,
LAST_VALUE(PKRC.CATEGORY) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS CATEGORY,
LAST_VALUE(PKRC.NOTIFICATION_CATEGORY) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS NOTIFICATION_CATEGORY,
LAST_VALUE(PKRC.PAYIN_CHANNEL) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS PAYIN_CHANNEL,
LAST_VALUE(RAS.USER_PROFILE_ID) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS USER_PROFILE_ID,
LAST_VALUE(RAS.USER_ID) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS USER_ID,
LAST_VALUE(IFF(WI.STATE = 'CLOSED',WI.LAST_UPDATED,NULL) ) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS DATE_CLOSED
FROM CTE
         INNER JOIN FX.WORK_ITEM WI ON WI.REQUEST_ID = CTE.TRANSFER_ID
         INNER JOIN REPORTS.REPORT_ACTION_STEP RAS ON RAS.REQUEST_ID = CTE.TRANSFER_ID
         LEFT JOIN  REPORTS.PKR_DOUBLE_PAYOUT_CLASSIFICATION PKRC ON PKRC.TRANSFER_ID = CTE.TRANSFER_ID

WHERE TRUE
 AND RAS.NOT_DUPLICATE = 1
 AND WI.TYPE = 'PROBLEMATIC_OOPS'
 AND CTE.TRANSFER_STATE = 'DPO'),


/*
 FETCHED TRANSFER IDS FROM SPREADSHEET -- FOR CONSISTENCY AS SOME BALANCES WERE CHANGED
 */

BANK_TRANSFER_CHECK AS (
    SELECT TRANSFER_ID,
        CASE
            WHEN TRANSFER_ID IN (508672253,510023805,508568826,509055880,509438795,507664080,507676000,508346492,509626198,507625179,508505264,508507500,510029450,508416669,508129833,508431697,507368112,510321487,507579837,508160361,507413502,509945617,509642297,509640040,508694483,507416093,507414271,507416711,507417431,507415380,509150506,509017494,509636691,507376710,508635563,508965192,508964198,508510295,507217214,507216069,507217736,507215232,509893338,508387556,510026127,507833373,508949515,507540917,507613676,510185601,507179790,507930540,509837019,510009252,508349916,508652686,509382406,507470755,508654812,508602746,508588972,509182363,509559526,507534112,508834943,510079992,510166853,508387384,508575907,509140359,510130103,510346637,507496194,508595650,509696847,509253314,509672942,509398626,509606647,509402883,507782154,507781558,508046323,508043611,507556515,508484312,509047475,508692665,508684769,508694124,508672297,508686129,510285689,510116459,505270340,508123476,509035451,510313338,507861314,509029873,508151181,508203529,507365211,509175143,507521973,509768520,509768962,509768701,508038971,508966872,508036061,508325877,508244039,508621057,508441596,506969130,506967712,507348513,507356548,510361470,508008993,509463380,507468749,508466976,507470423,509077133,508214833,507718068,509051829,507138259,508983975,507404522,510166028,510167097,507906348,507543370,507699097,508419811,510217611,507943444,507643976,510112800,508958650,509518758,507411729,508635786,508300787,507434564,507431172,507433919,507185656,507610309,509063707,508228663,510145659,508652159,507611096,507609262,507514752,507823960,508027931,507258035,507305757,509285475,507409508,510311353,509164529,509477427,508312498,510081941,510079577,507980392,507621181,509069069,508160463,508117958,509241850,508348268,507454811,507432282,508098010,508982990,509524075,509420503,508458532,507525347,507412884,508419167,508521551,508513931,507565450,507171668,507192461,508288792,503285905,509215868,508395915,507415716,507362797,508977913,508973536,509187422,509766844,507995433,509310145,507414542,507634951,507633382,508600557,509192064,508511635,507136335,508913870,507698901,507914349,507304885,508926734,509798484,510082056,509986963,508376723,508340983,507704144,507110443,508320810,507914807,507841251,507607022,507194005,508960028,509279049,508250715,507606321,509279422,509261563,507948656,507869896,508682106,509827389,508378862,510185502,508809131,509178825,509209916,508521634,507520658,509570329,509131907,509026702,507698567,507697984,507697731,507073567,507699200,508636854,507412887,509158180,509356675,510075068,507874875,509798382,510294354,508022727,508424974,508460914,507784192,508476478,508608022,509145959,508203083,508605502,509027863,509031556,508452615,507233406,507697173,508480413,509086295,508631800,507547755,507531170,507333543,507441331,507380566,509824151,509077193,509962099,509394404,507645999,507922092,509192355,507920350,508469100,507850479,507694476,508949566,510372855,507272618,507368900,508940617,508593057,508651869,507350232,507351118,507430775,509671870,505511915,508960954,507876088,508454631,509849538,509705488,509048106,509455150,507660280,510092868,507546326,509976136,507812056,508489826,510124908,509229579,509840494,507395679,507328861,509885937,507541570,507776039,510120999,508092120,508140040,510178383,509824539,509107874,508281303,509792526,510129967,507718365,507903818,508542876,507906747,507149972,508672560,508669477,508107359,507978094,509860264,507075635,508184720,509809778,507877009,508426359,507456502,507560050,507338473,507333384,507333719,507332661,507411154,507565223,507147821,510283420,510037779,510331430,508276146,509699501,507233028,507623692,507558066,507891548,509018364,509022121,508669053,508666912,508162872,507892320,508180314,509086577,509083295,509799775,508578674,510026739,508188749,508253193,509013798,507393906,508468345,508415523,507425369,507426713,510286024,509152910,509975491,509974506,507352031,509024247,507793442,509162019,509856269,508120794,508114281,507518427,509715316,509713323,510227731,509637483,510229229,507152763,508976983,508926719,509332151,509651581,509333745,510048128,508213864,507911106,509549556,507122176,507451354,508202567,508153349,508134786,508080985,508282783,508286765,507402270,510331133,510329112,509071629,509345387,509225586,508483019,507520965,510343704,509236080,508143052,507832110,507841845,507753611,509255620,509502462,507577270,509879380,508039430,507784743,507646433,508384999,507414453,508501563,507614710,507417168,507717603,506082155,510094743,507187032,508478735,508640512,509077679,510154922,510256571,509051497,508701928,508712745,509125540,508961451,508326454,507137038,507457320,509662845,509029789,509244089,509824187,509676826,509128442,507689120,508863557,506539013,509253741,509250952,507439201,509841678,507870058,510339092,508228155,509874313,509875266,507859649,507335610,509956903,507334942,510074523,508932935,509968371,507334143,508001210,508005558,509067386,507992675,507997219,507937118,507459341,509062196,509780917,509014744,507621568,509833367,507397890,507838301,507837180,509007099,510258127,510315666,507652906,507651080,509281675,509267037,507361764,509397552,507439523,507430413,507989187,510161683,508266609,508263463,510011541,509139500,508554595,509378611,508280166,507320215,509242637,509245553,509240208,509247172,509248975,509244473,507931431,510322111,507949677,510105703,507420524,508936207,508171149,508203965,508732756,507676491,507679466,507680407,509695836,509594962,508422602,507298251,510243810,508241776,510313479,509091819,509759852,509271741,508432215,507659495,508488126,510014979,507230057,507617102,509553142,507367908,509944377,509561513,508644755,509981135,507985439,507523576,507578993,507357837,508356275,509109296,509219850,509225936,509654113,508618691,507329561,507326613,508311957,508045689,507674021,509601650,510163191,510170643,507438017,508381988,509972779,509056898,508940764,509710172,507637711,507470094,507504097,507359955,509199768,509337470,507241479,507996094,510346317,508174321,507584868,508054261,507913103,507950626,509268940,509662034,507868223,509344137,508076183,508070173,508072945,509699241,508171456,508573706,508575469,508415780,507636247,507537094,508962923,509116628,507490705,509022778,507455840,507315416,507281951,510174962,510027887,508453007,509686580,507735303,508414448,510074831,509780551,509602167,510144334,507735950,507480228,507651804,508438500,508125088,507458541,509983944,510350745,509451473,510097794,508650267,507389377,507547055,507926987,508344636,508000069,510318885,508353940,509581521,509589548,508941922,507834683,508082567,508169448,509547382,507425917,506653912,508410101,509250756,507844866,509677755,509906352,508523382,509123344,507338894,509205376,509134754,508513907,509293724,507162404,507359097,509245077,509244787,509594047,509005640,509614945,509419203,507192959,507340743,509717024,508536137,508538319,509303229,510281580,509295730,508568947,509422626,505254501,507569444,507434074,508469082,508264107,509909857,509266202,510192521,509599288,505811618,507676922,509988190,509182310,509464107,508965639,508100688,510065499,509807289,508169611,510327318,508284368,507657295,509624275,508424102,509083198,507425936,508239913,509072756,509611251,509608741,508543210,508994706,507592475,507730879,507728068,507596478,507596785,509856262,510070003,508003428,507496259,508358973,507393240,509631359,509004811,509565454,507301348,508355131,509695000,509173037,509051631,508242798,509381156,507984418,507391966,509167654,507392667,509169573,508260712,506133883,509406479,509607061,508387738,508920042,510059976,508420892,509252002,508544400,507497698,507502498,507919142,510367339,509855943,507605763,507296272,508990559,509510304,508550831,507567187,507882174,507954860,508251276,509642569,509018072,508558009,508249034,507769537,510103932,508585400,507884926,509863916,507681976,509490961,510028131,510355905,509707181,509545803,507435695,508510611,510268148,509514740,509229804,510344885,508968435,509538367,510224929,508294346,510224143,509944344,509999587,507183536,507182266,509161875,510230305,507559508,507560277,508211379,510232464,507380579,508229515,510071736,509233488,508616180,507483099,509656424,509151815,507405064,509574481,508348749,509268267,509894320,509875574,507757978,510244580,510073340,510246488,507833935,507206718,510120716,507815071,510090352,510078124,510119435,510081611,510080135,510276087,510276854,509417210,507390558,508679682,509190464,510138074,507554062,509598459,507449548,508063676,507479023,508572062,509621115,508566609,510276823,509564537,509469361,508068970,507359511,509109738,507639719,509260736,509150279,509867798,507457486,510014809,509658816,510333153,507664795,508996096,507837013,509941167,508977308,509382277,507323561,507683685,508073582,507693693,509794278,510082034,507355712,510227432,507450364,509553781,509425742,508368452,507535819,508668393,508179253,508229529,509587073,509820709,510213611,509010859,509087592,508621225,508621795,509281717,509278061,509823890,507666169,508293903,509051115,507621691,507514467,509647369,508967609,508326186,507792791,508224824,507238373,510147770,507335966,507422298,509387544,507836977,508019329,508981929,508070002,508653216,507933177,508341780,509804993,509805251,507183224,508621885,509493180,507360325,510179899,507562911,507335467,508017842,508054009,509332561,509534886,507630463,507645452,510015221,507300313,509322224,508194173,507632360,509929331,507397999,507481070,508593260,508583360,507844202,508287408,509081859,507263141,508299579,508279204,507676160,508159801,508038616,509901379,509209258,507789347,508454683,509748588,509287003,508191686,507481891,507348273,508419835,509016223,507257146,508622657,507800195,508643849,508560833,508315768,508156114,508089080,508244240,508040075,508006066,508355484,510342181,510215533,509555177,507560568,509229245,508928404,507886279,509570539,507824298,508206268,509884671,507371643,509909065,507508752,507264934,510127904,507119166,508322367,507289411,507764760,509887364,510324618,508426897,510076812,508675071,509407282,508447790,507547042,508346140,507555639,507548798,508444187,508348383,508446635,508661589,507654047,508363005,508339303,507770596,507314791,508704383,508111731,509191832,509174240,507585233,508607444,509886923,506360428,507745229,508245961,507484492,508000009,510016269,507785362,507785881,507677424,507678745,507884575,510067475,510073648,510060878,509576272,507522591,507415400,507714275,507714834,509472037,508447350,509525312,508562132,507137174,507637681,508520286,508519893,508518440,509198247,510037015,509098434,507757293,508205787,508487838,507826183,509384660,510144491,508115641,509819122,507384331,509024549,507357967,508193097,509204967,510078867,507784638,508284334,509290125,509292638,507551128,508427816,507840460,507841914,507749528,509943476,509862616,508123615,509473060,508295707,508238964,507754837,509119906,509118597,507531594,508429228,507541077,509425512,508221091,510043485,508496013,509172227,509186502,509886267,509888110,508230512,508062093,508612412,508437563,507919046,507855558,509238450,508195809,508124605,510202219,507412464,509712817,509497533,507409265,507924162,509345190,508482703,507804791,509764371,508365841,508955832,509121900,509128267,507308464,506887330,507305086,509638245,507952429,510243784,510036400,507870958,509952527,510024346,509665933,507512663,507448295,507514966,507453201,507442543,507517379,507450507,508993373,510045149,508953541,507364993,507939058,508959775,509074495,510116400,507999791,508350217,510029805,507341837,507342481,507445824,509983802,509202177,509412287,510289936,509304884,509307955,509267994,510095615,509129463,510001723,508325404,507882828,509194343,507578006,507705153,509572826,509577498,508934907,508560523,509778605,507177844,508362255,507319566,510251663,507680157,508198809,507195313,507591246,507197507,507285701,507639249,507639968,507897933,509882597,508608765,509134753,507234708,507526850,509200977,507410717,509551702,510057331,510060873,508289043,507328792,507230236,507682447,508157361,510242201,508369292,509760888,507175066,507330415,507325333,507311321,510351594,508124162,510313609,507375988,508687025,508995384,507659471,507502571,508419087,507123442,508416714,508413822,510103195,509335966,507314155,508674094,509535899,509179487,509450238,508577191,507802884,507561780,508008361,507162465,507516146,509983066,507216745,509831505,507127349,507136371,507521411,507987344,508531423,508057646,509333828,509532561,509975663,508629046,508687209,507975992,507610275,509819943,507635432,507431528,509855693,507389313,507349041,509998713,507492370,508348937,507660407,507402792,507605080,509431345,507684141,508213668,509384307,509473061,507333618,508420037,507780862,510161901,509088880,507837081,509462628,505899827,507572071,507273142,507770872,508620180,509656995,508210068,509866423,509471176,509741048,510080258,508134406,507685572,509552882,509560076,510350700,508390297,509044877,509029887,509118683,509666626,507823524,507472859,507473414,509087390,509495691,510068743,509018191,510207598,508524616,507194790,508884056,508362710,507150385,507520625,509131839,507922167,508006511,509492275,508168435,507201312,507916025,508403265,508682475,510040907,507798449,509866665,507882879,509406596,509979818,507897256,507364470,507533417,507445159,507467443,509419953,509765940,508601315,508597196,508187304,508119321,508424502,509180832,507983008,507257070,509464443,509078941,507395343,509532429,509292634,506735451,508397653,508400763,508392909,510103972,508949650,507837508,509627796,510375094,510368017,507965449,507972183,509172895,509062080,507289951,508222167,509390706,509759307,508610950,509073652,509714733,509296810,509136511,507851767,507150994,509863299,509519606,509702123,510120508,510111554,510374164,507304702,508027221,508952980,506951900,507465954,508662562,507526558,509707310,507164115,507867490,509853761,507942349,510290215,509786707,509113759,507550589,509383081,507683579,507361756,507515224,509087151,509836924,509862926,509166672,508501878,508503982,508951063,507315560,509959258,507744115,507743848,507742943,508410371,508424718,508422235,507419599,507197316,510293442,509379541,510191560,510310618,509809782,509788602,509621286,509739178,509067846,509883796,507309172,508329378,507223956,507548440,507545116,507459737,507465195,507557014,508168675,507223821,509325791,509062970,509939112,508192187,510119910,507250384,507250518,509062738,509401895,509399878,510158663,507231317,509714891,509715764,508095275,507345871,509828317,508580092,509152225,509027177,510356045,507564192,508491158,510255693,507207892,510015208,507507802,507799227,507571879,509220230,509809995,509711600,510020181,507270594,507697167,507723183,507723944,509133310,508617598,508193601,508254954,510014523,510070286,509589639,508655148,508303390,509021742,507346121,507127618,508052318,510259108,507625101,508435653,509236862,507836649,508981781,509121347,509399978,509427315,507276145,508261837,509423796,507347984,510110940,508169812,509236427,510103820,508651983,507809196,505518951,509200996,507740425,508351088,509864874,508917775,508567859,509561191,509715994,508191401,509713483,507464291,508678076,509752069,510246707,508021969,507737328,509309038,509544426,509830383,507155144,508616870,507356568,509077249,509743348,508422202,509965737,508414338,508645989,508665113,507591725,509019250,509914700,507578193,508164871,507391900,508011339,509852186,509658842,508268370,509020429,509141092,510212531,507508713,510116403,507328839,509668497,509216892,509587160,507647598,507756919,507883436,508498787,507203774,508597839,508556219,508512516,510276214,509946412,509551921,508979658,508592965,508474318,508478162,508107472,508484667,509667958,509521699,507568949,507550504,510313890,510315993,509706266,509728792,508419359,509197461,509485838,507616402,510208621,508134569,507447902,509776862,507564090,508022475,508973356,508387276,510326815,509828484,510138464,507418121,510090478,510281391,508447639,510282300,508623902,509121243,509676028,509074017,509904848,509159563,509466405,507617636,510207542,510163138,507755446,509584054,509656484,507472314,509646358,507383426,510019134,509841107,507207466,509712111,510140168,510111520,509008035,509012603,509158868,508164714,508177088,509642925,508099814,507822381,507672314,509495945,510043069,507676016,507525589,507580190,510266458,509962341,509765229,509971970,507109912,510156220,507143958,508431324,509967346,510141046,508552010,508513731,504599131,507791674,507309766,508337417,510025166,507154946,509265911,510035037,507804840,510026981,508059307,508300102,507667613,508478355,508031486,507653470,507504767,508175670,509133608,507456303,509291375,509471729,508007438,507177016,508447494,508457285,508289583,509730652,507943702,508657072,510207964,507256868,507490931,508266645,509618835,508033099,508691223,509036802,510136453,510323432,508009051,507404886,508538928,508598415,508591814,510180357,510344856,508109846,509992278,509968768,508334268,507490480,509496459,508167653,509863108,509954994,509957435,509341767,509825024,509254306,509493064,509206936,508314151,508318300,508315147,509302653,510310265,507373790,510344038,510327387,507468388,507998182,508972206,510137229,507347183,508062435,507573478,508350645,510007245,509606193,507613392,507376370,508921926,509412251,507813825,508142061,508959022,510147557,507815337,507554240,508500262,510314221,510293530,507153556,507709562,507614342,507619921,507616673,510351858,508418118,508044174,507387272,509918042,507737787,508300513,508548361,509070748,509249872,508087416,509308276,509362375,509525682,509453900,509526804,509452121,505627022,507217384,507667421,510072919,509977148,508058697,510142727,508541894,509308181,509583273,509971331,507591317,507297719,509804131,508354908,510129871,510134105,510117207,507928071,509925650,507318756,509183249,509185769,509240767,507460195,508993680,507216999,508188915,507348086,507397659,509160353,508516437,507138650,508988522,507654410,508950965,507675155,508383408,509532710,510216430,507345528,509981109,508651164,508941340,507150554,509733026,507149552,507295977,509175264,508644061,509296327,509996128,509343292,509764414,507491524,506605523,510071796,510268720,507463559,507304932,507310659,509053849,507790605,508461994,507579563,509881109,507476032,510075845,510072588,509733054,509278140,507830371,507832577,510133967,509803752,509880114,509313559,508212745,507610792,507612089,510111564,510093897,509837501,509151164,509736596,509736329,508999230,508154326,508159529,508132824,509540103,508208203,509267523,509497045,507609626,510345892,509985160,507478261,507048790,510350786,507949545,509186938,509048655,507114645,509455678,509080510,507623719,507117883,509462297,507601618,509307443,508603740,509407992,509611982,509595085,507235728,507165839,507579784,509373298,507928553,509631738,507533322,509245763,509640164,509581609,510246603,509711202,509030321,510243631,510242991,508315733,509459831,509187423,507520509,507236504,507235999,507506091,507508737,507529226,507447258,509698635,509830271,507372819,508886186,508388236,509378565,507150654,506649634,507517754,508434759,509690432,510005394,509031214,507657846,508477990,507141163,507365558,508613152,510021169,507655008,509678687,508514756,510375255,507818544,510095413,508287011,510208522,507470200,507965443,507212537,507222781,508033704,507813378,507115512,508000296,508342672,508131905,510357260,507513947,507179953,507920319,507589735,507129434,507451535,510243642,510039039,507995217,509868625,508031193,508260401,509242168,508537900,506765386,509463414,508615121,508132455,510051728,509347603,507354843,507782078,507577567,509798907,509150998,508520965,507811589,507494605,510225666,508098546,510090589,509508470,509512012,508099384,508484549,509409218,508200907,507544955,508534198,508499339,509240827,510213613,510261775,510251203,488971990,508199041,509511689,509265679,506850715,509148742,507655806,507713551,507252984,509959363,509199723,509146935,508359755,508685819,509142251,509131282,508474769,508130166,510106289,499736292,508083778,508020849,509148639,507990114,507834489,507839710,508281227,507824672,509240711,508582366,508377070,510228242,507305375,507868417,509564896,507360789,509324694,509633938,508562957,509120711,507885165,508222333,510091875,509779017,509793942,507709466,510357039,510363890,510359304,510366945,507801587,510315402,509858418,508502667,508631370,509132467,508160259,509224950,509456508,507498074,507817116,508418779,510084424,508555352,507366952,509168088,507618178,510257870,508728392,507840469,508134438,508169093,508524129,507400290,508046109,509351077,508104357,509111666,510029596,507583042,510092052,508343966,510277205,510036037,510039975,509857855,509150037,507642719,508689001,509689611,509345106,509811104,507964913,508436462,507957259,509271785,508507872,507588144,507656958,509180869,510046718,510349114,509272124,507356472,509972213,507674122,507528812,507582088,508282435,507437282,507925037,507890241,508456380,506878805,508514966,508003864,507611068,510045690,510331923,509197632,508629241,506883494,507274779,508970938,507226786,510307986,508538622,508555266,509510029,509237453,507846443,510022672,510025031,508999652,509281801,508575403,507311280,507793527,507432538,508615680,508019130,508677929,508371153,507238326,507135242,508573585,507655410,509985778,510032514,509839774,510045379,509546186,509556600,508066189,509184151,509828446,508637867,508135196,509453287,508174520,502245755,508150646,509844414,509044506,508023688,508369968,509536039,509546135,507569846,509860521,509430401,510095818,508067003,510358872,508245764,509569851,507278989,508040259,507286992,509769535,509688164,509114286,510083405,508504106,507615757,507636525,508013624,507120471,509420091,508162512,507945781,510079364,509148309,509131504,509862901,508403141,509571409,509337352,507578897,507843464,510239172,509240899,508075730,506585516,506580199,509931073,507701479,508217294,508675958,507214199,509679791,507389993,507473296,507509081,507551900,508551829,508331822,510206670,509696800,508563373,508579480,508587341,509491235,509514184,509588111,509579597,509658634,509679353,509696543,509872579,510024731,510259899,510349451)
            THEN TRUE
        ELSE FALSE
    END AS BANK_TRANSFER_STATE
        FROM MAIN_TABLE
),

-- TRACK  RECOVERIES FROM BAK TRANSFER

BANK_RECOVERIES AS (

SELECT REQUEST_ID,SUM(BTL.LINKED_AMOUNT) as RECOVERED_AMOUNT, LISTAGG(DISTINCT BT.CURRENCY,',') AS RECOVERED_CURRENCY,
       CASE
           WHEN MAX(BTL.DATE) < '2022-12-14' THEN 'PRIOR_LEGAL'
           WHEN MAX(BTL.DATE) >= '2022-12-14' THEN 'POST_LEGAL'
           ELSE 'UNKNOWN'
       END AS RECOVERY_TYPE
FROM MAIN_TABLE
INNER JOIN FX.BANK_TRANSACTION_LINK BTL
    ON MAIN_TABLE.TRANSFER_ID = BTL.REQUEST_ID
INNER JOIN BSS.BANK_TRANSACTION BT
    ON BT.id = BTL.BANK_TRANSACTION_ID
WHERE TRUE
AND BTL.LINK_TYPE = 'RECEIVE'
AND BTL.REVIEWED_BY_ID !=236988
AND DATE_UPDATED > '2022-10-07' -- FOR IDENTIFYING TRUE REFUNDS
GROUP BY 1
)




SELECT
MAIN_TABLE.*,
RECOVERED_AMOUNT,
RECOVERED_CURRENCY,
COALESCE(RECOVERY_TYPE,'NO_RECOVERY') AS RECOVERY_TYPE,
CASE
    WHEN RECOVERED_AMOUNT IS NULL THEN 'NO_RECOVERY'
    WHEN RECOVERED_AMOUNT > AMOUNT_IN_SOURCE_CCY + 10 THEN 'UNKNOWN_STATE' -- CONSTANT IS USED TO ELIMINATE OUTLIERS EG FOR TX 509190897 THE DIFFERENCE IS 0.5 EUR
    WHEN (AMOUNT_IN_SOURCE_CCY - RECOVERED_AMOUNT)/AMOUNT_IN_SOURCE_CCY  < 0.05 THEN 'MORE_THAN_95_PERCENT_RECOVERED'
    ELSE 'PARTIAL_RECOVERY'
END AS BANK_RECOVERY_STATE,
AMOUNT_IN_SOURCE_CCY - RECOVERED_AMOUNT AS AMOUNT_REMAINING
FROM MAIN_TABLE
    LEFT JOIN BANK_TRANSFER_CHECK ON BANK_TRANSFER_CHECK.TRANSFER_ID = MAIN_TABLE.TRANSFER_ID
    LEFT JOIN BANK_RECOVERIES ON BANK_RECOVERIES.REQUEST_ID = MAIN_TABLE.TRANSFER_ID
WHERE TRUE
AND CATEGORY IN ('N4','N3')
AND AMOUNT_IN_GBP <= 800
AND BANK_TRANSFER_STATE = TRUE

