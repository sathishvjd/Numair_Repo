/*
 Author: Numair Fazili
 Description: The following query is used to track recoveries via bank transfers for affected transfers in N3/N4 category
 to whom legal letters were sent on 22 December 2022
 */


WITH CTE AS (
    SELECT DISTINCT PMT.TRANSFER_ID,COALESCE(PCL.PAYOUT_CLASSIFICATION,PMT.PAYOUT_CLASSIFICATION) AS TRANSFER_STATE
    FROM REPORTS.PKR_DOUBLE_PAYOUT_MASTER_TABLE PMT
    LEFT JOIN  REPORTS.PKR_DOUBLE_PAYOUT_CHANGE_LOG PCL ON PCL.TRANSFER_ID = PMT.TRANSFER_ID

),

MAIN_TABLE AS (SELECT
DISTINCT CTE.TRANSFER_ID AS TRANSFER_ID,
LAST_VALUE(CTE.TRANSFER_STATE) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS TRANSFER_STATE,
LAST_VALUE(WI.STATE) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS WORK_ITEM_STATE,
LAST_VALUE(SOURCE_CURRENCY) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS SOURCE_CURRENCY,
LAST_VALUE(TARGET_CURRENCY) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS TARGET_CURRENCY,
LAST_VALUE(INVOICE_VALUE_LOCAL) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS AMOUNT_IN_SOURCE_CCY,
LAST_VALUE(FEE_VALUE_LOCAL) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS FEES_IN_SOURCE_CCY,
LAST_VALUE(INVOICE_VALUE_GBP) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS AMOUNT_IN_GBP,
LAST_VALUE(WI.LAST_UPDATED ) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS LAST_UPDATED,
LAST_VALUE(PKRC.CATEGORY) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS CATEGORY,
LAST_VALUE(PKRC.NOTIFICATION_CATEGORY) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS NOTIFICATION_CATEGORY,
LAST_VALUE(PKRC.PAYIN_CHANNEL) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS PAYIN_CHANNEL,
LAST_VALUE(RAS.USER_PROFILE_ID) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS USER_PROFILE_ID,
LAST_VALUE(RAS.USER_ID) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS USER_ID,
LAST_VALUE(IFF(WI.STATE = 'CLOSED',WI.LAST_UPDATED,NULL) ) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS DATE_CLOSED
FROM CTE
         INNER JOIN FX.WORK_ITEM WI ON WI.REQUEST_ID = CTE.TRANSFER_ID
         INNER JOIN REPORTS.REPORT_ACTION_STEP RAS ON RAS.REQUEST_ID = CTE.TRANSFER_ID
         LEFT JOIN  REPORTS.PKR_DOUBLE_PAYOUT_CLASSIFICATION PKRC ON PKRC.TRANSFER_ID = CTE.TRANSFER_ID

WHERE TRUE
 AND RAS.NOT_DUPLICATE = 1
 AND WI.TYPE = 'PROBLEMATIC_OOPS'
 AND CTE.TRANSFER_STATE = 'DPO'),


/*
 FETCHED TRANSFER IDS FROM SPREADSHEET -- FOR CONSISTENCY AS SOME BALANCES WERE CHANGED
 */

BANK_TRANSFER_CHECK AS (
    SELECT TRANSFER_ID,
        CASE
            WHEN TRANSFER_ID IN (509877732,508922741,509161326,507640488,509582194,510058915,507425408,508460784,508347519,508187033,509171507,509531998,509356550,509238256,507680595,508105658,509632289,508412757,509209563,508679876,507819716,510107135,508643376,507477466,507903950,508567080,508034577,510200350,507198785,510226407,507744559,509626614,509936749,509823616,508000535,507263819,507666334,509985819,509413594,509128904,508428421,508435535,508040658,507699558,507257684,507591410,507875100,508470501,509646756,507602666,509275792,509213572,509798113,508531654,507889163,510019216,510351724,509168300,509644437,507361978,508432252,510018392,507425676,508355005,507339066,508296185,507493266,507488142,509498156,508259736,508636951,507639543,508365396,508434062,507166470,508931219,509657060,509238297,508371532,507144851,509032431,508945293,508943452,510087352,508535109,507191704,510030499,505105659,509750338,507237498,507718180,509194787,509287714,507530050,509577337,508331780,508111849,508946954,509514741,509164939,507417390,507427709,509885762,509599917,510331212,509213566,509518068,507626307,508569146,509240197,507475383,507617819,510199335,508523294,507371619,507248348,507661725,509268517,508007675,508307313,508085274,509584689,509078426,509077356,510079324,508607943,507694542,507681294,507328577,509392367,509103171,507607104,507806509,508137024,508559528,508551801,509688146,506845370,509553379,510114643,507685298,507397016,508351782,509421161,507582620,508671576,507814606,508947306,509811575,508172920,510056795,509817094,508215199,509350733,507180819,509527789,507817156,510168221,509050577,509801550,507477883,507897071,509545110,508011495,508570151,507807806,507815434,507329831,509326504,509405075,509368214,507682676,509106422,509631258,508344467,507443087,509776206,508540739,507769885,510335924,507517717,510310710,507688523,508258506,509785924,509348437,509169977,508448677,510044459,509560050,509559395,510243579,509257373,510187549,507229308,509754710,507500426,508349021,507868608,510188718,509469381,507861782,508432451,509808898,510130022,507795709,508114420,509946185,509528412,508110186,509206323,510289942,507676333,508127828,508275239,507423981,507413062,510353656,508111154,507491079,508195164,508594086,509747350,509979442,509712971,507839798,508616520,507430580,507352154,507384835,508231947,509349847,508024985,507663455,507142093,510335642,507779504,510075024,510365689,509203479,509990154,509420709,508519595,507550121,509723273,508508547,508101233,507486242,507305298,508035253,507955474,507953739,508209149,507387862,507383930,507449018,508513858,509435139,509816031,508058251,509724247,509746602,509400763,509403658,508600607,508033714,507447384,509072322,510301313,507382729,507453980,507241682,509076433,507657063,508354351,508974897,507667661,508078554,508075317,507180775,508502763,507254024,509874210,508169846,508997848,508363673,507349760,509107520,509538721,509140600,507342150,509314046,508037892,508209732,507488976,509715292,507566653,510090141,509696435,507238673,507412956,507865400,509040338,510354612,509376227,508932837,507681565,508414284,510190440,509468585,508928881,507598096,508562637,510218438,507481234,507461152,507331696,508505771,509177429,507134407,508964711,507335961,510340291,508138282,509852384,509421512,508076192,508094379,507674690,507575514,509966239,509441829,508631242,507631537,509058939,507854269,507866442,507306722,504338772,507485066,509229012,509121312,507402665,509846756,508961016,509557451,509054816,508663427,509546565,509561360,509125047,509977020,508454061,507390668,509630760,509631971,507810840,509355456,507537987,507539205,509072797,510374099,507412608,509060663,508666483,507667028,508182986,507258921,507267351,510343835,510156058,509267186,509514519,509040663,507295194,507422309,507338450,509758156,509366290,508977724,509350862,509588621,509374604,508495809,509362559,509075698,509532736,508520524,507719027,508426605,509154842,510129271,510094148,509244886,507606286,509375380,507831509,509942482,508345864,509934843,508307136,508692376,507963234,507353310,510201615,509261553,509567975,508450686,507362590,507505277,507454077,509265474,509250030,509130699,509137819,507818872,508032003,507708052,509640152,510140278,508516802,508501862,507426652,508998446,509554821,507520181,510083156,508329552,507909268,507772430,509038531,508147563,510376687,506950525,507208483,508563655,509245198,507342422,508213345,509263051,510256763,507347784,509286793,508979325,508484968,509589883,509170326,508377229,509713198,509676434,510305235,509789335,507305721,507503483,510038071,507866006,509082845,509645422,507461918,507628268,508423399,508213825,508473328,507446156,507938223,507168733,510058347,507889659,510329651,507194073,510310754,509226786,508489216,509655154,509736271,508335666,508124468,507836684,507670308,508684356,510224405,509569612,510200382,509642144,508164489,507620040,508452917,508303763,509983718,507980257,509950609,508337074,507812969,510111604,507475463,507475086,509932567,509503151,508679253,508689132,507975436,510122776,510222850,510210314,509176555,509134517,507343790,508273651,508025765,509185930,508618255,508551541,508092082,509061786,508956740,509790309,507474569,509696028,508353614,508057794,509618299,509387244,510231807,507460521,509938324,508590347,507680681,507680899,508606959,508025283,507489185,509932642,509934407,509887766,509790230,507837026,508173180,508618784,507820867,508377411,507827832,510162732,509439048,509669812,507739124,509475771,509474022,509198494,507698916,510259164,507637171,508610340,510264514,509453062,509489988,508482402,509261692,509395958,508610977,509200691,509299317,507118248,510082252,507706291,507169594,508979141,509340050,508342689,509271166,508305470,508436360,509310936,509560378,508682344,507490777,509601554,507670834,507510619,509810072,508683923,510063872,508648431,509600563,508021388,507965159,507656327,507200367,508215929,509711475,509709783,509290183,509287702,507450174,507910163,510034405,510092073,508336924,508126260,504108155,510011405,507943549,509509456,510298246,509390061,509898293,509316928,507415529,507932491,509953077,507501419,509268626,510349105,508650177,510323698,509687872,510361218,509071593,510354130,509413670,509858192,508667465,507783884,507756329,507756080,509879665,507230387,509390475,508500039,510180352,509604391,509555358,507807857,508417607,509389939,507248897,507402112,509080197,507707512,507934722,508219186,509647305,508348212,508231036,508955490,507352506,508942668,507534263,508278571,509508108,508491285,507597026,507433829,509270781,510208987,507165834,508533052,510203395,508185712,507624046,510143664,507642263,508331494,508249007,510028765,507398929,507288051,507587528,510056216,510129190,510184635,509414022,507303040,509322469,507931349,507924193,507130895,507516694,509346119,510341558,509089643,508682037,508021389,507248433,507140597,510307462,508160053,507874483,507278645,509180511,508122723,507394688,510252712,509714117,509970620,508481363,509722611,508913512,508595542,508583215,508486700,507572184,508491253,507542251,509440541,509819195,508946140,510229236,507637561,510192208,510191223,510190380,508253029,509078817,509951464,507458627,509561828,509479967,507555880,509318599,507147002,507146312,509966595,509177380,508051770,509374013,507122438,508994430,509008654,508260001,507430177,507299517,510279775,510355515,509661619,509826158,508539085,507643905,509860134,507398280,507436050,510168358,507368676,508248364,507629834,508618861,507478004,509583453,507639956,510159266,507424513,507423667,508360012,509679129,509131452,509688887,509045643,508652791,508643304,508510398,508330415,509059937,509741148,507687410,509309252,510244586,510167684,509297753,507299102,509525675,508958587,507934457,510003203,507381245,507265740,510179751,508544683,507588115,508247879,507757777,509656019,509121198,509893413,507815980,510286271,510017195,507386442,509506079,510070457,510195765,507142281,507527128,506908540,507944322,509923800,509457608,508038909,509360378,510295522,507692732,510140012,509550884,508153750,510318217,507686823,508956692,509206604,510232781,510169743,507499330,509952413,509951244,507473907,509186694,507846141,509710828,507217725,507411878,509682619,507464635,509679171,507687587,509660110,507960333,507964758,507673278,510221577,509008699,510257553,509267812,507354699,507375871,509874805,509416832,508427548,507480921,507240203,507783951,507544920,509521110,508557217,509236384,510296633,507349428,509380108,508347798,509489397,508191343,510365595,508672812,508136064,507472953,509221349,507263990,509550828,507951329,508445072,509297731,510333620,507112975,509543282,507117832,509589999,507116713,509805943,509259369,508071332,509515355,509964975,507179860,508968507,510271429,507629487,509432910,509844756,509676764,508072093,507623826,507348189,508661340,507917919,507206924,510091394,509130481,507555050,507600127,507589880,509708880,507593322,507459720,507424110,510116610,507212438,509995618,508562750,509501726,509217433,508575808,507451261,508536051,509694000,509057651,507667270,509592460,507177188,510121959,507147150,508915486,509589582,507915413,508274870,510318629,510312962,510377607,507211748,508345315,508543927,508500892,508535701,508313226,508555425,507684918,507901091,507400367,507774675,508056803,508493655,509092615,509195377,508206888,509145363,509625885,509513411,509351910,509861827,509417169,509508728,507550626,507435476,509135359,509422275,508353553,507627495,507920847,508164906,510187326,507398309,508473922,509188803,508403357,507363495,508070366,507320116,508035197,509402908,507758250,507529536,508958136,507521435,509396899,507761172,508251417,507242199,507443086,510259505,507438638,508669865,509323956,508313228,510042794,508079783,507382872,509308235,508380298,509331290,508407824,508179866,507925256,509194437,510030467,507390310,508938043,508996959,509182996,507658578,507447671,510221585,507815265,507465307,509893639,509672062,509778765,507755307,510174847,509054730,507212704,509529737,507495503,509208848,508000621,507642397,509636380,507605563,507275211,507738212,507738676,509074617,509514953,507382706,510192758,507449231,507212119,507588171,508490217,508452344,507457367,507883045,508466198,508314733,508339236,507450445,507450925,510158596,507626027,507671569,507698819,507410508,508024111,507960267,507996415,507882579,508024675,509529544,507263776,509265701,510186854,507718376,509034782,507442514,510351080,507213487,507596566,507550482,510077912,509636235,507680673,507501274,509266216,507877959,507291689,509756751,509061376,507969765,507746170,508467389,508061162,510265542,509777696,507651007,507573944,507237102,508501178,508321392,508523015,509094123,509139824,507691261,507690458,509742353,509479135,507766827,509362327,509644905,507888349,509367798,510045916,507576181,508283649,510187328,509982333,507240446,509221383,509964580,509558168,509154304,509003264,508295373,509898832,508246991,509153861,507421328,510322783,508913416,507581591,509663673,507600983,507652709,507656983,507660891,509241054,507530069,507867683,510062195,507581509,507416913,508604606,507419154,509156916,510179547,509802935,508210360,509236361,508501792,507879909,507568736,508446251,507251452,509654200,509187001,507116488,509129318,509463541,508229310,508414625,508492589,508945670,509397746,509243961,509864705,507709119,508064218,509654231,507589447,507350286,509747200,509182569,507474860,507435195,508073800,507577156,507252650,509758051,509047430,508577218,509630711,507336410,509437190,507965725,508657588,507470859,509963434,510162966,510125556,508949890,509639065,509331194,509307688,508233142,509404822,509872761,508260054,509730111,508175454,509841956,507298776,508545090,509827234,508200347,507879424,507365734,507170811,507318750,509009456,509541395,510010835,507596563,508143533,510091314,507179495,507741907,509165574,508540332,507191821,508245618,507299288,510309864,510288621,509520527,510003677,509392253,507929356,509363543,510145740,510064637,509595424,507164853,509095250,509426429,507143219,510129781,507294797,509665589,509578819,507434837,509199069,508437516,508281424,508643212,508641632,508687773,507541854,507539747,509848924,507496441,507401627,510125347,509256979,509347265,507411921,507610479,510347870,507695442,509197773,510319507,508683595,510251054,507504560,508047366,506468549,507559576,508532798,509251384,509482268,508366252,507654484,509625881,507141070,509863598,507285904,508303756,508624218,509433766,509756071,508442882,508976590,509907010,509611230,507290390,510374891,509788400,508939783,507330488,510087486,507430605,509117046,509916919,507711762,509771649,509673035,507651598,510124772,509295610,509508526,509827020,507740247,509178810,507301795,509392064,509360316,508990082,510301778,508541389,510298828,509518280,508052758,510158800,507919134,507646716,509784023,507531537,508193662,509667398,507883630,507512511,509176180,509848793,507286452,507353023,509448769,507294899,507654733,507444741,510025018,507631458,508460720,507397675,507494353,508019062,510010283,509425056,509133598,508499387,508072912,510084394,508115514,507636037,507202918,509412858,508238792,509514709,509515424,507678876,508578841,507836290,510175896,509695633,509413896,509930317,508413178,509285468,507950061,509323336,508944725,507395022,509980238,509111389,510236965,507145483,509994147,508077229,507986248,509011987,510315291,507357817,507154374,509572981,509542008,509544286,510340728,509832134,509053909,510339100,509426899,509984312,510010049,510121769,509333422,509593742,507939508,507590516,507590944,510139181,510365226,507543832,507714213,510361348,508260737,508442776,508001412,509596592,507896388,509119831,508468307,508122085,509718692,510057162,509736632,507643772,509880956,508544931,509545875,510255438,507729349,507825964,507765979,507456479,507965336,509471939,509550791,508651090,507474506,510276895,510349867,505526511,508456727,507517943,509479579,509658867,509767478,507826303,507823335,508315510,508299669,507273700,509711848,508442122,507424302,510268146,509314649,507627269,509724698,508094953,507343918,507501521,510335227,508746281,508013745,508689483,509749892,507208217,509461630,509303570,508663840,508413179,510192657,507387442,508600468,507488960,507979497,509984051,507451054,507977684,507537435,508561522,509591546,507852704,508089542,508610922,509665331,510122073,507882547,509187245,507459799,507133943,506872021,509550845,507793201,509869339,507322131,509891056,509929805,508534144,508470358,507843264,507757003,510101276,507367963,507520211,507457965,507708254,508555091,508646672,507197501,507647501,509094656,507421286,509044239,507811865,509707520,507461634,508395800,507504463,507506960,507126833,509029542,508000695,509896359,508489511,509157103,509875425,510280459,507310507,509573743,507399749,507700430,507683178,507681706,508023642,507479355,509451279,509181783,507536273,509525646,509117625,507455023,507243481,507527640,510250373,510335270,507552605,507690620,507310887,509175458,510292757,510101184,508396945,508287664,509395998,508654070,510286220,509464258,509578362,510369641,507036652,507793917,510305319,507609256,507776826,508990017,508039835,509007132,509290006,507141024,507475963,508600717,508154484,510353129,508554169,510143035,508500313,508338889,510167998,508056786,508058547,509637542,509050418,507202006,509847944,509164708,510005383,508047768,509298400,509650070,509518654,509191876,509381606,507500281,508225191,507379155,507554958,508620818,507304620,508588575,509129138,507356925,508382724,509745684,510110847,507225857,508929162,509106372,509281733,510146915,509053690,510320824,507535126,509159713,510055492,509426741,509569439,507610190,507159838,507164930,507954545,507603425,507150224,508186267,508594136,507873165,509653944,508543722,507432026,510049485,509627411,509361694,507637844,508112909,508589407,507731477,509796649,509962281,509543252,507430096,508505414,509303647,509853437,507512535,509640387,509338785,509290989,509644362,507184138,508249583,508140176,510295084,510322143,507223584,508949234,509729168,510119547,507226327,508313220,510090990,509052180,507382363,510050136,510243767,509117269,509652938,507815208,510225990,507636025,510147533,510130967,510272898,509629822,507506689,509838102,508505999,508506903,508506493,508505523,507567475,508445282,507152514,507994856,508323570,509936416,509493227,507490764,508180344,507621880,508540177,509959290,510061484,509212310,508668804,508511354,509622929,509966533,510030526,506591665,507789407,509240825,509140935,508008362,509715288,509044633,510224349,507625559,508094521,509762909,507432872,507247846,507474450,509510560,508615437,507681428,508578397,507341982,508618953,508332431,507783018,507321674,509942837,510191534,508358727,508361073,508356891,508353231,508447668,508017347,509743884,508680782,507300907,509903055,509369184,507607920,510023257,509165263,510032778,508416544,509879689,509568438,509013539,507126039,509719165,508929739,507444172,510365205,508437089,507244663,509387473,507214911,509165587,509538992,508464592,508455865,510068992,510032551,509626712,507302190,510331968,509510154,510320030,507380208,508601205,507766813,509446666,507552633,507535254,508269855,507416447,508511397,509279296,509263517,507682809,509849663,509469055,509728418,510218447,508195562,508946114,507377087,507388038,507653931,507231915,509028955,507968906,507842432,507457037,507360833,510262728,507844045,507741673,508145341,509115496,509322125,507853331,508408025,508140907,508576905,509254640,510345550,510042526,508387364,508424789,509546867,507955839,508330383,508382293,508361686,508980151,508427688,510082134,510128863,508200664,508336738,510320073,509725784,507627068,510038256,508262230,506959619,510099859,507637698,509998573,509127328,509511619,507122573,510291154,509623393,507318597,507113277,507781928,509619002,508649432,509450091,508089514,507346151,509164409,507482567,509056701,509527260,508657896,508397961,510359890,510078994,510055451,508241633,508358323,508362640,509593953,509971620,507596349,509584436,508341481,509753707,509277396,508586739,509858160,508614060,510190980,507839802,510159487,507388768,507189736,508630510,508554049,509093512,507911493,508998871,510378271,510215909,508762149,507380308,509604251,509013676,507556405,508159156,508161521,509472482,508330821,510150129,510126807,507328890,508292847,510037159,507121347,510341466,508493250,507612818,509309972,510145599,509674001,507401560,507640147,508578576,509062188,509703559,508938380,509206444,509631699,509564021,509678423,508531759,507839091,509186268,509189067,510029393,507871939,509712042,510278138,510056516,507242176,507752933,507290429,507754640,509336416,509023412,508938580,507775769,509966554,510125831,507306273,508913930,509616070,508414409,509685427,507244012,508230191,507332548,509948305,509398746,507196052,508227784,509529504,510074081,510298090,509831009,509193872,509594583,509592979,509107128,509127306,510057667,508191724,509673281,510300348,509544578,510088877,508665916,508539037,510086296,508125491,508970313,508690003,508597827,507306687,507163423,509804795,508176181,507314209,508181535,509307662,510221095,507806267,509477064,510061240,509873783,510359824,509659727,509890764,509075330,510241895,508588713,509600036,507824543,509163528,509541309,510182982,508196475,508194177,507396755,509128660,508980304,507477089,509321659,509163268,507404645,509346856,509931824,509688475,509894119,507969034,509149722,507521622,507610365,507834132,509404533,507580523,507839108,509265827,508473923,510367539,508053908,508386390,508368436,509083277,509086193,507700732,508000977,508347020,509098306,509212455,509111959,507234997,509652449,507136355,510280325,510080541,507782552,509401244,507547330,509987955,508234498,509231080,507567253,509678986,508606217,507540703,510300360,509483538,508195847,508312958,508002085,508960394,507211393,509657442,509167897,508688194,507274897,507205285,509244470,507101162,507105800,507106983,507811201,510288425,509506824,509504677,508291734,507995474,510266335,509124208,507245126,507354871,507353365,507710905,509285240,507905979,509189780,509844988,508679127,509448568,508680877,508593960,507898839,510056936,507182311,509409058,509571237,509991661,507880212,508683606,507554006,507219812,509155719,507998955,509500930,510276018,510019545,509183132,507658064,507190088,508018568,510134443,508234880,507135307,510115957,508076907,507606474,502703118,509118019,507419907,508312572,509766595,509766955,507699016,509345774,508579178,510329057,510352762,507182003,509970969,509764131,509052327,509194774,507574510,508670630,509343411,509817814,509149031,509955249,509340212,509387028,509223082,507610746,509894682,507737008,507215200,507464187,508182133,508557571,509289075,510252448,509635284,510271915,507576173,509574313,509152517,509088105,510327033,507716981,507345029,508547643,508274527,510222316,507633435,507319292,508454782,508473668,507562669,508620895,507557671,507924576,509556419,509958480,508306727,507653478,509000674,509900763,508023456,508022105,508155960,508106177,507633318,509215448,506425252,507586332,507533688,507781537,508344571,509178714,507224537,509058424,509888031,508633276,510197615,510198445,510199428,508615422,507422639,508274794,509424143,507130048,509326444,509309247,507436890,510129543,507194593,508421092,507468205,509226797,507957659,507432173,509324399,507616400,507439489,507556739,509488425,508575479,509460260,508467792,508409633,507370591,509284766,509283713,510037750,508251165,507048018,507447958,510014912,507402512,507838255,507231857,507717414,507323600,509236719,507358101,507206700,509190226,510120720,509054168,509559968,508126531,508588071,508563529,504912347,508494301,509776972,508354067,509596305,508580505,507706847,509145536,508458137,509925489,509475764,509545840,507502420,509325055,509418197,508130665,507526649,510060375,509695128,510184745,507626178,509979629,507191232,509438485,507577979,508138742,510237320,507479632,510208018,507719658,509702992,509531162,507674199,507176474,509516001,507362953,510190097,507585508,510126801,510097804,508406232,507545420,508165072,507585975,509281419,507503651,508482688,510146503,509559642,508184253,507324089,507123765,507283595,510378625,507356295,509781413,510091538,508472444,510231642,508449073,509971460,510352448,509080547,509180535,507346314,507901831,508342191,507135568,507417981,507414086,509249623,508181139,508273334,510214761,509253023,507658907,508441436,507584551,509250077,509227381,509039553,509366508,509537447,510123143,507598176,509552500,509951428,510068175,507205993,509848459,507243730,510258460,510210212,509794873,507599142,507339081,509226117,507564223,507141997,507890930,510337122,510234759,510345899,507386667,507229482,507670359,509812964,508526379,508581313,510172720,510194477,509243337,510109585,509713167,509621796,508415248,510095715,507711968,510340144,509796492,509939858,509301671,508219644,507150807,509163124,510368023,507308860,509994367,507920390,507740494,508349192,508349031,509475600,508167054,510030006,510167715,509846279,509667142,508452360,507395656,509314147,509275565,507577880,509015046,509876027,509907418,509924641,509590973,507396227,509786922,509363955,510329652,508172443,509636729,510038502,507615480,509391344,509096503,509881027,509501812,508295050,508480412,509646909,507630259,509450240,510133135,508692144,507658405,507955547,508275031,509471948,510246595,508296286,509014078,509111838,507400237,507200771,507391808,507124527,510358785,508510315,509507111,509826515,508106016,509499175,508245829,507472347,509898659,508585721,509106260,510052333,507270353,508043982,508033984,510280016,510274548,508274335,509202645,508569494,507213047,509174405,509048544,508226892,508493935,509724175,507509801,507812676,509404154,508957232,509322034,507705708,507827006,507239763,509575293,510104982,507679869,507616426,507591432,507850000,509099966,508627522,508058489,507594570,508453025,509620655,507265831,509794046,509795270,507832176,508632812,507126709,507617162,507510614,509061913,507399240,509078587,507724193,507691472,508532924,510308216,509581674,509996528,509230017,509231356,508458383,509348593,509331987,510338867,510292412,509371736,509481057,507178841,508399743,508346607,509023852,507261245,507137822,507517512,507543178,507470204,510096242,507303810,509250806,508762616,507246870,510231565,508124959,508397847,509344047,509260382,509647249,509858511,507471468,509645449,508359299,508226261,509387855,509950971,509096376,509087296,509698889,509237251,510129154,510132547,509048199,508299889,507471726,509405419,507869752,507263406,507210868,510172284,506929768,507144484,507154664,507369176,507505859,507242027,507250563,507276888,509011467,507321941,507342326,507358612,507373795,508916024,507387791,507449697,507505990,509371070,507522832,508233700,507526066,507568343,507653144,507602892,507624418,507635643,507676117,507756942,507880656,507974168,509184811,508135269,509153450,508279260,508305916,508313972,508468950,508539332,508547204,508576115,509070285,509669356,508996025,509023095,509025219,509114999,509121478,509140943,509143430,509193372,509281406,509296040,509322339,509365532,509388326,509600782,509601724,509679918,509680178,509700771,509989152,509759197,509857379,509956934,510131133,510074673,510103728,510127995,510131536,510182325,510254762,510322935,510337956,510328860)
            THEN TRUE
        ELSE FALSE
    END AS BANK_TRANSFER_STATE
        FROM MAIN_TABLE
),

-- TRACK  RECOVERIES FROM BAK TRANSFER

BANK_RECOVERIES AS (

SELECT REQUEST_ID,SUM(BTL.LINKED_AMOUNT) as RECOVERED_AMOUNT, LISTAGG(DISTINCT BT.CURRENCY,',') AS RECOVERED_CURRENCY,
       CASE
           WHEN MAX(BTL.DATE) < '2022-12-22' THEN 'PRIOR_LEGAL'
           WHEN MAX(BTL.DATE) >= '2022-12-22' THEN 'POST_LEGAL'
           ELSE 'UNKNOWN'
       END AS RECOVERY_TYPE
FROM MAIN_TABLE
INNER JOIN FX.BANK_TRANSACTION_LINK BTL
    ON MAIN_TABLE.TRANSFER_ID = BTL.REQUEST_ID
INNER JOIN BSS.BANK_TRANSACTION BT
    ON BT.id = BTL.BANK_TRANSACTION_ID
WHERE TRUE
AND BTL.LINK_TYPE = 'RECEIVE'
AND BTL.REVIEWED_BY_ID !=236988
AND DATE_UPDATED > '2022-10-07' -- FOR IDENTIFYING TRUE REFUNDS
GROUP BY 1
)




SELECT
MAIN_TABLE.*,
RECOVERED_AMOUNT,
RECOVERED_CURRENCY,
COALESCE(RECOVERY_TYPE,'NO_RECOVERY') AS RECOVERY_TYPE,
CASE
    WHEN RECOVERED_AMOUNT IS NULL THEN 'NO_RECOVERY'
    WHEN RECOVERED_AMOUNT > AMOUNT_IN_SOURCE_CCY + 10 THEN 'UNKNOWN_STATE' -- CONSTANT IS USED TO ELIMINATE OUTLIERS EG FOR TX 509190897 THE DIFFERENCE IS 0.5 EUR
    WHEN (AMOUNT_IN_SOURCE_CCY - RECOVERED_AMOUNT)/AMOUNT_IN_SOURCE_CCY  < 0.05 THEN 'MORE_THAN_95_PERCENT_RECOVERED'
    ELSE 'PARTIAL_RECOVERY'
END AS BANK_RECOVERY_STATE,
AMOUNT_IN_SOURCE_CCY - RECOVERED_AMOUNT AS AMOUNT_REMAINING
FROM MAIN_TABLE
    LEFT JOIN BANK_TRANSFER_CHECK ON BANK_TRANSFER_CHECK.TRANSFER_ID = MAIN_TABLE.TRANSFER_ID
    LEFT JOIN BANK_RECOVERIES ON BANK_RECOVERIES.REQUEST_ID = MAIN_TABLE.TRANSFER_ID
WHERE TRUE
AND CATEGORY IN ('N4','N3')
AND AMOUNT_IN_GBP <= 800
AND BANK_TRANSFER_STATE = TRUE