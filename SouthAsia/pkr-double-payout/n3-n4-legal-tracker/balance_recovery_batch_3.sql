/*
 Author: Numair Fazili
 Description: The following query is used to track recoveries via balance reservations for affected transfers in N3/N4 category
 to whom legal letters were sent on 22 December 2022
 */


WITH CTE AS (
    SELECT DISTINCT PMT.TRANSFER_ID,COALESCE(PCL.PAYOUT_CLASSIFICATION,PMT.PAYOUT_CLASSIFICATION) AS TRANSFER_STATE
    FROM REPORTS.PKR_DOUBLE_PAYOUT_MASTER_TABLE PMT
    LEFT JOIN  REPORTS.PKR_DOUBLE_PAYOUT_CHANGE_LOG PCL ON PCL.TRANSFER_ID = PMT.TRANSFER_ID

),

MAIN_TABLE AS (SELECT
DISTINCT CTE.TRANSFER_ID AS TRANSFER_ID,
LAST_VALUE(CTE.TRANSFER_STATE) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS TRANSFER_STATE,
LAST_VALUE(WI.STATE) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS WORK_ITEM_STATE,
LAST_VALUE(SOURCE_CURRENCY) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS SOURCE_CURRENCY,
LAST_VALUE(TARGET_CURRENCY) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS TARGET_CURRENCY,
LAST_VALUE(INVOICE_VALUE_LOCAL) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS AMOUNT_IN_SOURCE_CCY,
LAST_VALUE(FEE_VALUE_LOCAL) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS FEES_IN_SOURCE_CCY,
LAST_VALUE(INVOICE_VALUE_GBP) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS AMOUNT_IN_GBP,
LAST_VALUE(WI.LAST_UPDATED ) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS LAST_UPDATED,
LAST_VALUE(PKRC.CATEGORY) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS CATEGORY,
LAST_VALUE(PKRC.NOTIFICATION_CATEGORY) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS NOTIFICATION_CATEGORY,
LAST_VALUE(PKRC.PAYIN_CHANNEL) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS PAYIN_CHANNEL,
LAST_VALUE(RAS.USER_PROFILE_ID) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS USER_PROFILE_ID,
LAST_VALUE(RAS.USER_ID) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS USER_ID,
LAST_VALUE(IFF(WI.STATE = 'CLOSED',WI.LAST_UPDATED,NULL) ) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS DATE_CLOSED
FROM CTE
         INNER JOIN FX.WORK_ITEM WI ON WI.REQUEST_ID = CTE.TRANSFER_ID
         INNER JOIN REPORTS.REPORT_ACTION_STEP RAS ON RAS.REQUEST_ID = CTE.TRANSFER_ID
         LEFT JOIN  REPORTS.PKR_DOUBLE_PAYOUT_CLASSIFICATION PKRC ON PKRC.TRANSFER_ID = CTE.TRANSFER_ID

WHERE TRUE
 AND RAS.NOT_DUPLICATE = 1
 AND WI.TYPE = 'PROBLEMATIC_OOPS'
 AND CTE.TRANSFER_STATE = 'DPO'),
/*
 FETCHED USER PROFILES FROM SPREADSHEET -- FOR CONSISTENCY AS SOME BALANCES WERE CHANGED
 */
BALANCE_CHECK AS (
    SELECT USER_PROFILE_ID AS PROFILE_ID,
        CASE
            WHEN USER_PROFILE_ID IN (11151,22286,191437,191437,232107,399657,493716,493716,582749,725959,763723,778002,798551,800504,801338,825278,838443,838443,868788,934022,991441,1051719,1053812,1090524,1112461,1159566,1159566,1221658,1256943,1256943,1270218,1284725,1338634,1390018,1406505,1482546,1484703,1484970,1500166,1530301,1571796,1650391,1685505,1694537,1694537,1715027,1729494,1764516,1836739,1888869,1905096,1929163,1929163,1971304,1983461,1987171,2033152,2038941,2058044,2243166,2256552,2286313,2299107,2472073,2509981,2509981,2568045,2618036,2653655,2706308,2728795,2863976,2937406,2950934,2963903,2969497,2970977,3037877,3207462,3279625,3297582,3363234,3405215,3444190,3446055,3511848,3585652,3619960,3619960,3722390,3856756,3950926,4030893,4158471,4182701,4274192,4424707,4438396,4447406,4462548,4468546,4512207,4525173,4535885,4591527,4623326,4638062,4641216,4681703,4688947,4698818,4807794,4885013,4935636,4974660,5016788,5056818,5056818,5067565,5106094,5209039,5244206,5251488,5289598,5337144,5370622,5411644,5412737,5413635,5413635,5442725,5442725,5487314,5493256,5503138,5511094,5556535,5564067,5589485,5604525,5608721,5608721,5610092,5636129,5693746,5706684,5764195,5771492,5774318,5818518,5832315,5854334,5858377,5908838,6013094,6028101,6031496,6031947,6055835,6094993,6130983,6135416,6148053,6148053,6178149,6178149,6185817,6203136,6249853,6303391,6313816,6325008,6413573,6413573,6516388,6570359,6584097,6733784,6750829,6767087,6767087,6767087,6773003,6791916,6852807,6861232,6942646,6991684,6996429,7002421,7008663,7010336,7051566,7051566,7052159,7069199,7105579,7283372,7297879,7297879,7360414,7362282,7398925,7433430,7451919,7451919,7505620,7521389,7535883,7560359,7594679,7647900,7711587,7718315,7718315,7723990,7729094,7733364,7733364,7782167,7785381,7787282,7822528,7822528,7822528,7824883,7829388,7829388,7829776,7847197,7847843,7890619,7916037,7926126,7926126,7955171,7980983,8028558,8041482,8073240,8073240,8078700,8163033,8163033,8163033,8205751,8211118,8306664,8336010,8420233,8429840,8429840,8440596,8503008,8516332,8516332,8608594,8608594,8609800,8694395,8697357,8701057,8741799,8816366,8838901,8908862,8925377,8983907,9001564,9022614,9025474,9075327,9121044,9174620,9176137,9177709,9214671,9242081,9242081,9269523,9269755,9303579,9326161,9330612,9366225,9366429,9396573,9411917,9439221,9459580,9473172,9497940,9499667,9501168,9531265,9542433,9563854,9680588,9697991,9697991,9725741,9740205,9748451,9759727,9761858,9766779,9798867,9874796,9918498,9918498,9940269,9990106,9990106,10061973,10078293,10084517,10097544,10098386,10122664,10129084,10137161,10169217,10317754,10380598,10423537,10445136,10483223,10604203,10630308,10630308,10670297,10694424,10799769,10814775,10821238,10821238,10825779,10863255,10892035,10893558,10903092,10924494,10931525,10943980,10951265,10951265,10952993,10967737,10976347,10979148,11022317,11064153,11078717,11093444,11099002,11099002,11116156,11123526,11155477,11246795,11278521,11300941,11399008,11472889,11546507,11719204,11750132,11793798,11793798,11793798,11793798,11793798,11793798,11793798,11832096,11894339,11936674,11939536,12019951,12054739,12073575,12078425,12094229,12170423,12183577,12213037,12220390,12234652,12287261,12329786,12348814,12366780,12366780,12370252,12370252,12385702,12440509,12447004,12471282,12471290,12479476,12479900,12502932,12568052,12604960,12614980,12614980,12614980,12614980,12652651,12667748,12730031,12736087,12736087,12736330,12750381,12807858,12832874,12843044,12843044,12939799,12939799,12946210,12961075,13010939,13075845,13077934,13106243,13117896,13117896,13157195,13170922,13170922,13170922,13205792,13222900,13225408,13239336,13293861,13405631,13415369,13452583,13499056,13508373,13557653,13570160,13592360,13605327,13621024,13643182,13681761,13687810,13690116,13704208,13727725,13752373,13752786,13794523,13835495,13891603,13919818,13919818,13920417,13933817,13990078,13999812,14013302,14017307,14024665,14074618,14090155,14115932,14115932,14507382,14511221,14528324,14533749,14559006,14578649,14599216,14617378,14623282,14631617,14635306,14647258,14647258,14647258,14653422,14653422,14727298,14727298,14750211,14764212,14801834,14817507,14817507,14821540,14848900,14849372,14913774,14913774,14974189,14997891,14997891,15036856,15099059,15131702,15137389,15137389,15164780,15164780,15174105,15189261,15196643,15216997,15248144,15261219,15263997,15285476,15285834,15285834,15308797,15311042,15399252,15442527,15567548,15569035,15634608,15696061,15742012,15786571,15787641,15791094,15801085,15807699,15810640,15826744,15865883,15882057,15889446,15896700,15896700,15951570,15978255,16018060,16031535,16056658,16075392,16075392,16173450,16174211,16178931,16190293,16210779,16225126,16225831,16228726,16253405,16266981,16275288,16282176,16339639,16350418,16358945,16359256,16366710,16402189,16428272,16431372,16470391,16514618,16542409,16564125,16564125,16576621,16595557,16608533,16623163,16665582,16665582,16718674,16720599,16745304,16745910,16777387,16828031,16838663,16852165,16858211,16895227,16931442,16951015,17029316,17050358,17110397,17119855,17190032,17217572,17243139,17244005,17244005,17285593,17323342,17323342,17324854,17339736,17347539,17348798,17348798,17369750,17369750,17376878,17413450,17461894,17467380,17493620,17550610,17570922,17581125,17613773,17656658,17678613,17726617,17792256,17794326,17807925,17843419,17849918,17864605,17887636,17889626,17918725,18023744,18049836,18101556,18141730,18141730,18141730,18160507,18178031,18209134,18209134,18209134,18209134,18224657,18265798,18271537,18355312,18370593,18373920,18388617,18394720,18459201,18469061,18470299,18491330,18491881,18499530,18509431,18515477,18566931,18567776,18574476,18590779,18594496,18601859,18601859,18617993,18639679,18639679,18644554,18646780,18661675,18661675,18663306,18697683,18701881,18714083,18722653,18733024,18747018,18759246,18781478,18784593,18787584,18817623,18817623,18843126,18872753,18934532,18947452,18955260,18999884,19024787,19082441,19101657,19113148,19113700,19163532,19180095,19202636,19202636,19202636,19202636,19341353,19346058,19364638,19366604,19427341,19435952,19435952,19478041,19484778,19502061,19523624,19545041,19657628,19668781,19684692,19698303,19719585,19733046,19769047,19804246,19807854,19815858,19815858,19816076,19823859,19828015,19873881,19875121,19912227,19937496,19945847,19953901,19973398,20035421,20045829,20059084,20065791,20076280,20080092,20103753,20105603,20168212,20172246,20177471,20182480,20182480,20182480,20182714,20218986,20219597,20231664,20322382,20328458,20334713,20335609,20335609,20337058,20386679,20418733,20447242,20464852,20468427,20481512,20483054,20483054,20486568,20499752,20507585,20536177,20537948,20550279,20556426,20556426,20573256,20649086,20662269,20705377,20735483,20738100,20741986,20779918,20791292,20812681,20894834,20935989,20950661,21030063,21046386,21104628,21124347,21133247,21137429,21143109,21150929,21152274,21303040,21309288,21342963,21386709,21403047,21417760,21424936,21424936,21431344,21434784,21507918,21519997,21536345,21538378,21541436,21541436,21635157,21640104,21678668,21678668,21688493,21688805,21689719,21693307,21697297,21704661,21711689,21750910,21791572,21797249,21812050,21853345,21867910,21868848,21873639,21875400,21896320,21924567,21932159,21932159,21932159,21932237,21939196,21939196,21939196,22019305,22045704,22058013,22064609,22067533,22141169,22158322,22177824,22252295,22252295,22254741,22254741,22256498,22271850,22280737,22300521,22323740,22342457,22377765,22391069,22424149,22442635,22481493,22507653,22531814,22531814,22541211,22650105,22692340,22749937,22761725,22813548,22833404,22852085,22860022,22970482,22988299,22992191,23018225,23039033,23074452,23092060,23113885,23143308,23163325,23176744,23202877,23207918,23227214,23227269,23236822,23267268,23313031,23324564,23348647,23353775,23358060,23580126,23586996,23608373,23617793,23617793,23638474,23638474,23657735,23693289,23695905,23706243,23710988,23710988,23740835,23761304,23761343,23796662,23824799,23829597,23848693,23848693,23866371,23897301,23915592,23946275,23974451,23975647,24003797,24003797,24006407,24006407,24006407,24006407,24006407,24006407,24024215,24064991,24117025,24124300,24187752,24218585,24233507,24266171,24267568,24274806,24358993,24478032,24485343,24515855,24523601,24549501,24559998,24582614,24590758,24607901,24611380,24619476,24619476,24630264,24632865,24635574,24640281,24688380,24711758,24711758,24715234,24728255,24728255,24733172,24759670,24762614,24830074,24872025,24916208,24917718,24934527,24938340,24938340,24986024,25004832,25006850,25012044,25026952,25037583,25127829,25158574,25171833,25173416,25175667,25179078,25192072,25192072,25192214,25192214,25211458,25216250,25267894,25267894,25268120,25278056,25303159,25311349,25331647,25367626,25379148,25380485,25395706,25420821,25434364,25441039,25445419,25445419,25478926,25491046,25507616,25537072,25539454,25543447,25543580,25543580,25544082,25544082,25566339,25577427,25583656,25589501,25598652,25599532,25600002,25602766,25625482,25656081,25698263,25707683,25710376,25725467,25752860,25761681,25805561,25827608,25832605,25869184,25886664,25898473,25906311,25926969,25943928,25943928,25943928,25943928,25956764,25971407,26010911,26017486,26021163,26025271,26096809,26109638,26130780,26137832,26149067,26151042,26158004,26184684,26212829,26265825,26279682,26355231,26355231,26355231,26357590,26373338,26441237,26491635,26494105,26509367,26525521,26525521,26559541,26563955,26589832,26620906,26635582,26643575,26669035,26728387,26747270,26758606,26767587,26767587,26819711,26825566,26842548,26843576,26846766,26852021,26861580,26872162,26889919,26927653,26934820,26934820,26938831,26957925,26963432,26975289,26986526,27027436,27085310,27115411,27125991,27149997,27151451,27160474,27161181,27171707,27240003,27250673,27257707,27333149,27342951,27356543,27356543,27365495,27373424,27373424,27456087,27462655,27473513,27473513,27488246,27528692,27572462,27649091,27655686,27673013,27698381,27709426,27709426,27712100,27712100,27720151,27730634,27742157,27745338,27751884,27781213,27843593,27845984,27849773,27869940,27869940,27879251,27889449,27894710,27894753,27902716,27921148,27938898,28001754,28005827,28038678,28048614,28124591,28142266,28186185,28280221,28432855,28455165,28507773,28601335,28644692,28679648,28694424,28755716,28790020,28790158,28793052,28798337,28801307,28822823,28822995,28831348,28855271,28867741,28867741,28867741,28867741,28908961,28908961,28955023,28985863,29001748,29012604,29012604,29014508,29015192,29015192,29015192,29087276,29087276,29102281,29151348,29167635,29167635,29167635,29174073,29177573,29227582,29235428,29300172,29327002,29418747,29511991,29513935,29520363,29529742,29582151,29611891,29640589,29653831,29701941,29709688,29737902,29776015,29819028,29822377,29844901,29930967,29937353,29978107,30073058,30160883,30180654,30187098,30220360,30246723,30334638,30372394,30420342,30442897,30467971,30478056,30492093,30555231,30568411,30572269,30579746,30579746,30604500,30608669,30672421,30684819,30695429,30758413,30797765,30826965,30894445,30961630,31054550,31086175,31097554,31100684,31108891,31227287,31227287,31246418,31271434,31272454,31303461,31341275,31363594,31368688,31446651,31447179,31475752,31513270,31513270,31513270,31535536,31555471,31568658,31568658,31602865,31602865,31629935,31639349,31639349,31647369,31647369,31669159,31684692,31721311,31754158,31806289,31826556,31826556,31827908,31836100,31888502,31936506,31942816,31952871,31993519,32010610,32178814,32212414,32212922,32212922,32309364,32341082,32382537,32442253,32448546,32514860,32523875,32544936,32548838,32557024,32603402,32603821,32616579,32618359,32629237,32645351)
            THEN TRUE
        ELSE FALSE
    END AS BALANCE_RESERVATION
        FROM MAIN_TABLE
    GROUP BY 1
),

-- FOR USERS WITH MULTIPLE TX

-- GET EOD BALANCE

GET_LATEST_BALANCE AS (
SELECT
    RBHBP.PROFILE_ID as GET_BALANCE_PROFILE_ID,
    AMOUNT_CURRENCY AS BALANCE_CURRENCY,
    SUM(LOCAL_BALANCE_END_OF_DAY) AS BALANCE_AMOUNT,
    SUM(GBP_BALANCE_END_OF_DAY) AS BALANCE_GBP
FROM REPORTS.REPORT_BORDERLESS_HISTORIC_BALANCES_PROFILES RBHBP
WHERE TRUE
AND PROFILE_ID IN (SELECT BALANCE_CHECK.PROFILE_ID FROM BALANCE_CHECK WHERE BALANCE_RESERVATION = TRUE)
AND DATE_BALANCE = CURRENT_DATE() - 1
GROUP BY 1,2
),

GET_PRIOR_LEGAL_BALANCE AS (
SELECT
    RBHBP.PROFILE_ID as GET_BALANCE_PROFILE_ID,
    AMOUNT_CURRENCY AS BALANCE_CURRENCY,
    SUM(LOCAL_BALANCE_END_OF_DAY) AS BALANCE_AMOUNT,
    SUM(GBP_BALANCE_END_OF_DAY) AS BALANCE_GBP
FROM REPORTS.REPORT_BORDERLESS_HISTORIC_BALANCES_PROFILES RBHBP
WHERE TRUE
AND PROFILE_ID IN (SELECT BALANCE_CHECK.PROFILE_ID FROM BALANCE_CHECK WHERE BALANCE_RESERVATION = TRUE)
AND DATE_BALANCE = '2022-12-22'
GROUP BY 1,2
),


CREATE_LATEST_BALANCE_VIEW AS (SELECT
MAIN_TABLE.USER_PROFILE_ID,
SOURCE_CURRENCY,
SUM(AMOUNT_IN_SOURCE_CCY) AS AMOUNT_IN_SOURCE_CCY,
SUM(AMOUNT_IN_GBP) AS AMOUNT_IN_GBP,
MAX(BALANCE_AMOUNT) AS BALANCE_AMOUNT,
MAX(BALANCE_GBP) AS BALANCE_GBP,
COUNT(TRANSFER_ID) AS COUNT_TX,
LISTAGG(WORK_ITEM_STATE,',') AS WORK_ITEM_STATES,
IFF(MAX(BALANCE_GBP) < 0, SUM(AMOUNT_IN_GBP) + MAX(BALANCE_GBP),NULL) AS BALANCE_PAID_GBP,
'LATEST' AS TYPE
FROM MAIN_TABLE
    LEFT JOIN GET_LATEST_BALANCE ON GET_LATEST_BALANCE.GET_BALANCE_PROFILE_ID = MAIN_TABLE.USER_PROFILE_ID AND GET_LATEST_BALANCE.BALANCE_CURRENCY = MAIN_TABLE.SOURCE_CURRENCY
WHERE TRUE
AND USER_PROFILE_ID IN (SELECT BALANCE_CHECK.PROFILE_ID FROM BALANCE_CHECK WHERE BALANCE_RESERVATION = TRUE)
AND CATEGORY IN ('N4','N3')
AND AMOUNT_IN_GBP <= 800
AND ((DATE_CLOSED IS NULL) OR (DATE_CLOSED >= '2022-12-09'))
GROUP BY 1,2
HAVING SUM(AMOUNT_IN_SOURCE_CCY) <= 200),


CREATE_PRIOR_BALANCE_VIEW AS (SELECT
MAIN_TABLE.USER_PROFILE_ID,
SOURCE_CURRENCY,
SUM(AMOUNT_IN_SOURCE_CCY) AS AMOUNT_IN_SOURCE_CCY,
SUM(AMOUNT_IN_GBP) AS AMOUNT_IN_GBP,
MAX(BALANCE_AMOUNT) AS BALANCE_AMOUNT,
MAX(BALANCE_GBP) AS BALANCE_GBP,
COUNT(TRANSFER_ID) AS COUNT_TX,
LISTAGG(WORK_ITEM_STATE,',') AS WORK_ITEM_STATES,
IFF(MAX(BALANCE_GBP) < 0, SUM(AMOUNT_IN_GBP) + MAX(BALANCE_GBP),NULL) AS BALANCE_PAID_GBP,
'PRIOR_LEGAL' AS TYPE
FROM MAIN_TABLE
    LEFT JOIN GET_PRIOR_LEGAL_BALANCE ON GET_PRIOR_LEGAL_BALANCE.GET_BALANCE_PROFILE_ID = MAIN_TABLE.USER_PROFILE_ID AND GET_PRIOR_LEGAL_BALANCE.BALANCE_CURRENCY = MAIN_TABLE.SOURCE_CURRENCY
WHERE TRUE
AND USER_PROFILE_ID IN (SELECT BALANCE_CHECK.PROFILE_ID FROM BALANCE_CHECK WHERE BALANCE_RESERVATION = TRUE)
AND CATEGORY IN ('N4','N3')
AND AMOUNT_IN_GBP <= 800
AND ((DATE_CLOSED IS NULL) OR (DATE_CLOSED >= '2022-12-09'))
GROUP BY 1,2
HAVING SUM(AMOUNT_IN_SOURCE_CCY) <= 200),


TEMP_TABLE AS (

    (SELECT * FROM CREATE_LATEST_BALANCE_VIEW) UNION ALL (SELECT * FROM CREATE_PRIOR_BALANCE_VIEW)

)

SELECT
TYPE,
CASE
    WHEN BALANCE_AMOUNT >= 0 THEN 'RECOVERED'
    WHEN BALANCE_AMOUNT < 0 AND ABS(BALANCE_AMOUNT) > ABS(AMOUNT_IN_SOURCE_CCY) THEN 'UNKNOWN_STATE'
    WHEN (AMOUNT_IN_SOURCE_CCY - ABS(BALANCE_AMOUNT))/AMOUNT_IN_SOURCE_CCY  > 0.1 THEN 'PARTIAL_RECOVERY'
    ELSE 'NO_RECOVERY'
END AS BALANCE_RECOVERY_STATE,
    ROUND(SUM(AMOUNT_IN_GBP)) AS AFFECTED_AMOUNT_GBP,
    IFF(SUM(BALANCE_GBP) < 0,ROUND(SUM(BALANCE_GBP)),0) AS REMAINING_BALANCE_GBP,
    ROUND(COALESCE(SUM(BALANCE_PAID_GBP),SUM(AMOUNT_IN_GBP))) AS AMOUNT_PAID_GBP,
    SUM(COUNT_TX) AS NUM_TRANSFERS,
    COUNT(DISTINCT USER_PROFILE_ID) AS NUM_PROFILES,
    ANY_VALUE(CONCAT(USER_PROFILE_ID,'-',SOURCE_CURRENCY,'-',AMOUNT_IN_GBP)) AS SAMPLE_USE_CASE_USER_CCY_AFFAMTGBP,
    LISTAGG(USER_PROFILE_ID,',') AS LIST_PROFILES
FROM TEMP_TABLE
GROUP BY 1,2 ORDER BY 1
