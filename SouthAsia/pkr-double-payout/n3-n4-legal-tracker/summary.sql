/*
 Author: Numair Fazili
 Description: The following query is used to consolidate the affected transfers in N3/N4 category to whom legal letters were sent on 1st December 2022
 */



WITH CTE AS (
    SELECT DISTINCT PMT.TRANSFER_ID,COALESCE(PCL.PAYOUT_CLASSIFICATION,PMT.PAYOUT_CLASSIFICATION) AS TRANSFER_STATE
    FROM REPORTS.PKR_DOUBLE_PAYOUT_MASTER_TABLE PMT
    LEFT JOIN  REPORTS.PKR_DOUBLE_PAYOUT_CHANGE_LOG PCL ON PCL.TRANSFER_ID = PMT.TRANSFER_ID

),

MAIN_TABLE AS (SELECT
DISTINCT CTE.TRANSFER_ID AS TRANSFER_ID,
LAST_VALUE(CTE.TRANSFER_STATE) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS TRANSFER_STATE,
LAST_VALUE(WI.STATE) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS WORK_ITEM_STATE,
LAST_VALUE(SOURCE_CURRENCY) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS SOURCE_CURRENCY,
LAST_VALUE(TARGET_CURRENCY) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS TARGET_CURRENCY,
LAST_VALUE(INVOICE_VALUE_LOCAL) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS AMOUNT_IN_SOURCE_CCY,
LAST_VALUE(FEE_VALUE_LOCAL) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS FEES_IN_SOURCE_CCY,
LAST_VALUE(INVOICE_VALUE_GBP) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS AMOUNT_IN_GBP,
LAST_VALUE(WI.LAST_UPDATED ) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS LAST_UPDATED,
LAST_VALUE(PKRC.CATEGORY) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS CATEGORY,
LAST_VALUE(PKRC.NOTIFICATION_CATEGORY) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS NOTIFICATION_CATEGORY,
LAST_VALUE(PKRC.PAYIN_CHANNEL) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS PAYIN_CHANNEL,
LAST_VALUE(RAS.USER_PROFILE_ID) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS USER_PROFILE_ID,
LAST_VALUE(RAS.USER_ID) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS USER_ID,
LAST_VALUE(IFF(WI.STATE = 'CLOSED',WI.LAST_UPDATED,NULL) ) OVER (PARTITION BY CTE.TRANSFER_ID ORDER BY LAST_UPDATED) AS DATE_CLOSED
FROM CTE
         INNER JOIN FX.WORK_ITEM WI ON WI.REQUEST_ID = CTE.TRANSFER_ID
         INNER JOIN REPORTS.REPORT_ACTION_STEP RAS ON RAS.REQUEST_ID = CTE.TRANSFER_ID
         LEFT JOIN  REPORTS.PKR_DOUBLE_PAYOUT_CLASSIFICATION PKRC ON PKRC.TRANSFER_ID = CTE.TRANSFER_ID

WHERE TRUE
 AND RAS.NOT_DUPLICATE = 1
 AND WI.TYPE = 'PROBLEMATIC_OOPS'
 AND CTE.TRANSFER_STATE = 'DPO'),


/*
 FETCHED USER PROFILES FROM SPREADSHEET -- FOR CONSISTENCY AS SOME BALANCES WERE CHANGED -
 */

BALANCE_CHECK AS (
    SELECT USER_PROFILE_ID,
        CASE
            WHEN USER_PROFILE_ID IN (27389812,12669441,22192697,4421584,10607947,22890726,21038055,28996105,13056653,21314088,4032811,24929356,
                                     13983231,10387648,4950149,18307520,15816156,26112931,25253669,6984323,32294651,12574037,22115437,29115373,
                                     15759843,27282743,31841648,19754558,822613,14874273,32034581,1568441,14043824,4686776,24596756,19512849,15009712,
                                     30526742,12322750,8871976,19801361,16469918,23665024,17649532,13505410,32561274,31499739,29359079,7184156,19975232,
                                     15266861,6973709,18640108,5696887,17174145,14870939,13644876,19801361,28735898,31499739,1834460,2091935,15090444,24674294,
                                     26671955,27282959,26412526,14613397,19647928,21102721,6792712,22060897,5603548,26468769,13469966,14707323,7982093,27898140,13320598,
                                     7550108,24775875,5006749,18506026,2040406,2040406,24930387,2040406,21572707,26059220,24184316,5367369,1834460,10811803,24765118,17931902,
                                     15231511,28802219,16172619,18129288,7508667,17421736,19250424,13871661,11557076,8821372,31980872,1569834,7979192,13043611,20085914,29444540,
                                     18832599,29358657,32601790,19801361,6344028,29371623,15970945,7504628,17239046,30504143,28342178,32605150,21088212,19119254,13360273,6756634,
                                     27282959,9903225,15945344,27801306,24889972,20233589,27137584,26649308,25479574,12669441,19069041,21235184,25874626,32606268,27600290,15232155,
                                     24903273,12433369,14670004,20440214,26403151,17882610,23062142,1967665,18447296,19894193,5928505,5928505,6939499,31057360,13354265,23037629,13727153,
                                     18161581,17895175,23335672,17522157,4830129,6597266,25919154,1834460,19801361,20015032,29185923,30086825,30086825,32630768,6209000,16247097,30165254,
                                     6887614,30386714,16787776,2022849,16469918,31269492,19145283,26013634,14122405,4138377,15479812,10420505,19268760,5554189,25629636,21651831,30757290,4616320,
                                     14597818,12845224,20730006,16596260,1569834,32646178) THEN FALSE
            WHEN USER_PROFILE_ID IN
                 (916652, 30255384, 16793388, 18407993, 9204246, 9184616, 3833229, 15237919, 31952871, 6773064,
                  19785767, 31952871, 2651965, 16951015, 20044804, 31952871, 31965849, 28674942, 16686882, 23277573,
                  28222419, 6713326, 25312614, 23128901, 20164616, 31084723, 29125883, 23997932, 21912706, 16951015,
                  17989627, 19472463, 16390422, 27161087, 27161087, 5329495, 29944147, 29944147, 3737839, 21131024,
                  6373206, 22827919, 16112388, 30309890, 2267771, 12256969, 23997932, 29195587, 26577669, 20350224,
                  14660635, 7816602, 18976409, 26495092, 11465892, 23997932, 9149766, 26308186, 9149766, 17376828,
                  25784765, 20398860, 1500036, 5106094, 14530803, 14530803, 14530803, 8793242, 26153269, 5006124,
                  18148865, 30073274, 26153269, 15034424, 5792429, 20407635, 28116727, 2694363, 31806445, 13515979,
                  27852652, 31385496, 16745304, 25319744, 20700338, 29923770, 2008450, 20139480, 29326674, 23963642,
                  11987873, 24640281, 24923218, 9743217, 20477773, 19432287, 32174029, 27011145, 27333566, 3847793,
                  32174029, 4807794, 29386649, 3366022, 24590186, 8620027, 7633481, 23533991, 18724272, 21643867,
                  20139480, 27954951, 26826118, 26842776, 26842776, 28619229, 26842776, 26842776, 9959900, 24919656,
                  22671696, 1743441, 14808457, 14579391, 30361061, 30361061, 30361061, 30361061, 30361061, 10695807,
                  24281035, 7342066, 7342066, 25887512, 11399008, 25649738, 9219050, 20071170, 21673716, 21673716,
                  324733, 22721657, 25880823, 23137099, 30653143, 16842895, 3773379, 27011145, 20137513, 17203826,
                  15046133, 1077355, 23513928, 22128028, 24435100, 6777503, 20784851, 30785710, 21491653, 20405397,
                  29430714, 29098140, 19379480, 26362712, 21550027, 23407194, 31948934, 24531546, 31222401, 25975400,
                  31222401, 21763608, 9048760, 11196260, 24590186, 26196551, 26636358, 19704170, 9985908, 24747161,
                  18776751, 27333566, 28649200, 28792029, 9105838, 25772771, 15685078, 10112893, 19704170, 17367854,
                  14808457, 1380798, 14834188, 27499555, 31084723, 28581256, 18295288, 17893045, 13732403, 25772771,
                  23997932, 25319744, 26120399, 2372160, 31047419, 5442725, 25617161, 13620007, 13620007, 30527811,
                  29214477, 22827919, 18467573, 9048760, 9109089, 706169, 4799428, 4799428, 19416621, 22797623,
                  31084723, 15742012, 27252951, 25034292, 20680251, 29217273, 27121257, 9204246, 10619694, 15161709,
                  7364452, 25234927, 11372938, 25234927, 11372938, 11372938, 11372938, 4815526, 17329607, 16346014,
                  30186362, 30186362, 27014565, 21402403, 25675944, 32345508, 10696745, 10696745, 19588369, 10696745,
                  10696745, 10696745, 10696745, 15884824, 19026372, 29691646, 29691646, 32461848, 9557436, 23270958,
                  8938140, 17359830, 28317454, 8837326, 28377184, 30286397, 9568406, 28513226, 10696745, 10696745,
                  16660453, 30784330, 20740498, 18466261, 5769057, 15352998, 18813636, 9048760, 28581256, 14607985,
                  17339843, 14609875, 2372578, 11372938, 11372938, 13499056, 25594532, 25367626, 30875770, 27278289,
                  30875770, 20986226, 29227582, 29227582, 9667545, 18236492, 5842823, 24590186, 31434802, 820901,
                  11246795, 15339446, 23818959, 3620810, 22213961, 17579153, 12256969, 12256969, 20438515, 21478856,
                  24632249, 12569689, 11155477, 21768008, 15063936, 17893045)
            THEN TRUE
    END AS BALANCE_RESERVATION
        FROM MAIN_TABLE
    GROUP BY 1
)

SELECT
MAIN_TABLE.USER_PROFILE_ID AS USER_PROFILE_ID,
LISTAGG(TRANSFER_ID,',') AS TRANSFER_IDS,
LISTAGG(DISTINCT WORK_ITEM_STATE,',') AS WORK_ITEM_STATES,
COUNT(TRANSFER_ID) AS TRANSFER_COUNT,
LISTAGG(DISTINCT BALANCE_RESERVATION,',') AS BALANCE_RESERVATION,
SUM(AMOUNT_IN_GBP) AS AMOUNT_IN_GBP
FROM MAIN_TABLE
    INNER JOIN BALANCE_CHECK ON BALANCE_CHECK.USER_PROFILE_ID = MAIN_TABLE.USER_PROFILE_ID
WHERE TRUE
AND BALANCE_RESERVATION IS NOT NULL
AND AMOUNT_IN_GBP > 800
AND CATEGORY IN ('N3','N4')
AND WORK_ITEM_STATE != 'CLOSED';